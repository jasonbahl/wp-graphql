language: php

sudo: false

notifications:
  email:
    on_success: never
    on_failure: never

branches:
  only:
    - master
    - develop

matrix:
  include:
#    - php: 5.5
#      env: WP_VERSION=latest WP_MULTISITE=0 PHP_UNIT_VERSION=4.8
#    - php: 5.6
#      env: WP_VERSION=latest WP_MULTISITE=0 PHP_UNIT_VERSION=4.8
#    - php: 7.0
#      env: WP_VERSION=latest WP_MULTISITE=0 PHP_UNIT_VERSION=5.7
    - php: 7.1
      env: WP_VERSION=latest WP_MULTISITE=0 PHP_UNIT_VERSION=6.3
#    - php: 5.5
#      env: WP_VERSION=latest WP_MULTISITE=1 PHP_UNIT_VERSION=4.8
#    - php: 5.6
#      env: WP_VERSION=latest WP_MULTISITE=1 PHP_UNIT_VERSION=4.8
#    - php: 7.0
#      env: WP_VERSION=latest WP_MULTISITE=1 PHP_UNIT_VERSION=5.7
#    - php: 7.1
#      env: WP_VERSION=latest WP_MULTISITE=1 PHP_UNIT_VERSION=6.3
  fast_finish: true

services:
  - mysql

addons:
  apt:
    packages:
      - libjpeg-dev
      - libpng12-dev
      - php5-fpm
      - php5-mysql
      - nginx
  hosts:
    - wp.localhost

env:
  global:
    - WP_FOLDER="/tmp/wordpress"
    - WP_URL="http://wp.localhost"
    - WP_DOMAIN="wp.localhost"
    - DB_NAME="test"
    - TEST_DB_NAME="wploader"
    - WP_TABLE_PREFIX="wp_"
    - WP_ADMIN_USERNAME="admin"
    - WP_ADMIN_PASSWORD="admin"

before_install:
  # create the databases that will be used in the tests
  - mysql -e "create database IF NOT EXISTS $DB_NAME;" -uroot
  - mysql -e "create database IF NOT EXISTS $TEST_DB_NAME;" -uroot
  # set up folders
  - mkdir -p $WP_FOLDER
  - mkdir tools
  # install wp-cli in the `tools` folder
  - wget https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -P $(pwd)/tools/
  - chmod +x tools/wp-cli.phar && mv tools/wp-cli.phar tools/wp
  # append the `tools` folder to the PATH
  - export PATH=$PATH:$(pwd)/tools
  # prepend the `vendor/bin` folder the PATH
  - export PATH=vendor/bin:$PATH

# Composer package installation
install:
  # Install composer packages, will also trigger dump-autoload
  - composer install
  # Install coveralls.phar
  - wget -c -nc --retry-connrefused --tries=0 https://github.com/satooshi/php-coveralls/releases/download/v1.0.1/coveralls.phar
  - chmod +x coveralls.phar
  - php coveralls.phar --version
  # Install GraphQL Schema Linter
  - npm install -g graphql-schema-linter

before_script:
  - bash bin/install-wp-tests.sh $TEST_DB_NAME $WP_ADMIN_USERNAME $WP_ADMIN_PASSWORD localhost $WP_VERSION
  - composer self-update
  - composer require phpunit/phpunit:$PHP_UNIT_VERSION
  - composer install --no-interaction
  - mkdir -p build/logs
  - ls -al

script:
 - vendor/bin/phpunit --group ajax
 - vendor/bin/phpunit --coverage-clover build/logs/clover.xml


after_success:
  - travis_retry php coveralls.phar -v
  - wp graphql generate-static-schema
  - graphql-schema-linter schema.graphql

cache:
  directories:
  - vendor
  - $HOME/.composer/cache
